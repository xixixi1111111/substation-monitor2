<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å˜ç”µç«™ç®¡ç†">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192x192.png">
    <title>å˜ç”µç«™æœºå­ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .page {
            display: none;
            max-width: 100%;
            margin: 0 auto;
        }

        .page.active {
            display: block;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .substation-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .substation-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .substation-item:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }

        .substation-item:active {
            transform: scale(0.98);
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .add-substation {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-substation input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .install-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #fff;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            transition: all 0.3s;
        }

        .install-btn.show {
            display: block;
        }

        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 999;
            display: none;
        }

        .install-banner.show {
            display: block;
        }

        .install-banner h3 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .install-banner p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
        }

        .install-banner .btn-group {
            display: flex;
            gap: 10px;
        }

        .install-banner .btn-install {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .install-banner .btn-later {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .manual-install {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .manual-install h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .manual-install .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .manual-install .step-num {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .manual-install .step-text {
            color: #333;
            font-size: 14px;
        }

        .install-btn.show {
            display: block;
        }

        .map-page {
            padding: 10px;
        }

        .map-header {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-header h2 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .config-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .config-form input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .machine-grid {
            display: grid;
            gap: 10px;
            margin: 0 auto;
            width: fit-content;
        }

        .machine-cell {
            width: 60px;
            height: 60px;
            border: 2px solid #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f0f0;
            position: relative;
        }

        .machine-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .machine-cell.has-data {
            background: #4CAF50;
            color: white;
        }

        .machine-cell .machine-icon {
            font-size: 24px;
        }

        .back-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-bottom: 15px;
        }

        .machine-detail-page {
            padding: 20px;
        }

        .detail-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .detail-card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .camera-preview {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #videoElement {
            width: 100%;
            display: block;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .camera-controls button {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:disabled,
        .form-group textarea:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: wait;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .image-preview {
            width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }

        .image-preview.active {
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: white;
        }

        .sync-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .sync-status .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .sync-status .indicator.active {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sync-actions {
            display: flex;
            gap: 10px;
        }

        .sync-actions .btn {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 2000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 3s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        @media (max-width: 480px) {
            .machine-cell {
                width: 50px;
                height: 50px;
            }

            .machine-cell .machine-icon {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <button id="installBtn" class="install-btn" onclick="installApp()">
        ğŸ“± ä¸€é”®å®‰è£…
    </button>

    <div id="installBanner" class="install-banner">
        <h3>ğŸ“± å®‰è£…åˆ°æ‰‹æœºæ¡Œé¢</h3>
        <p>å®‰è£…ååƒåŸç”ŸAPPä¸€æ ·ä½¿ç”¨ï¼Œæ— éœ€æ¯æ¬¡æ‰“å¼€æµè§ˆå™¨</p>
        <div class="btn-group">
            <button class="btn-install" onclick="showManualInstall()">æŸ¥çœ‹å®‰è£…æ­¥éª¤</button>
            <button class="btn-later" onclick="dismissInstall()">æš‚ä¸å®‰è£…</button>
        </div>
    </div>

    <div id="manualInstallModal" class="install-banner" style="top: 0; bottom: auto; background: #667eea; color: white;">
        <h3 style="color: white;">ğŸ“± å®‰è£…æ­¥éª¤</h3>
        
        <div class="step" style="background: rgba(255,255,255,0.2);">
            <div class="step-num" style="background: white; color: #667eea;">1</div>
            <div class="step-text" id="modalIosStep1" style="display:none; color: white;">ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ã€Œåˆ†äº«ã€æŒ‰é’® â–¡</div>
            <div class="step-text" id="modalAndroidStep1" style="color: white;">ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ã€Œä¸‰ä¸ªç‚¹ã€â‹®</div>
        </div>
        
        <div class="step" style="background: rgba(255,255,255,0.2);">
            <div class="step-num" style="background: white; color: #667eea;">2</div>
            <div class="step-text" id="modalIosStep2" style="display:none; color: white;">æ»‘åŠ¨æ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€å¹¶ç‚¹å‡»</div>
            <div class="step-text" id="modalAndroidStep2" style="color: white;">ç‚¹å‡»ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€æˆ–ã€Œå®‰è£…åº”ç”¨ã€</div>
        </div>
        
        <div class="step" style="background: rgba(255,255,255,0.2);">
            <div class="step-num" style="background: white; color: #667eea;">3</div>
            <div class="step-text" style="color: white;">ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ ã€å®Œæˆå®‰è£…</div>
        </div>
        
        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn-install" style="background: white; color: #667eea;" onclick="closeManualInstall()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="substationSelectPage" class="page active">
        <div class="substation-select-page">
            <div class="header">
                <h1>å˜ç”µç«™æœºå­ä¿¡æ¯ç®¡ç†</h1>
                <p>æœ¬åœ°å­˜å‚¨ Â· ç¦»çº¿å¯ç”¨</p>
            </div>

            <div class="manual-install">
                <h3>ğŸ“± å¦‚ä½•å®‰è£…åˆ°æ‰‹æœºæ¡Œé¢</h3>
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-text" id="iosStep1" style="display:none">ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ã€Œåˆ†äº«ã€æŒ‰é’® â–¡</div>
                    <div class="step-text" id="androidStep1">ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ã€Œä¸‰ä¸ªç‚¹ã€â‹®</div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-text" id="iosStep2" style="display:none">æ»‘åŠ¨æ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€å¹¶ç‚¹å‡»</div>
                    <div class="step-text" id="androidStep2">ç‚¹å‡»ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€æˆ–ã€Œå®‰è£…åº”ç”¨ã€</div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-text">ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ ã€å®Œæˆå®‰è£…</div>
                </div>
            </div>

            <div class="sync-panel">
                <h3 style="margin-bottom: 15px;">ğŸ“¡ å±€åŸŸç½‘åŒæ­¥</h3>
                <div class="sync-status">
                    <div id="syncIndicator" class="indicator"></div>
                    <span id="syncStatusText">æœªè¿æ¥</span>
                </div>
                <div class="sync-actions">
                    <button class="btn btn-primary" id="hostBtn" onclick="startHost()">å¼€å§‹å¹¿æ’­</button>
                    <button class="btn btn-primary" id="connectBtn" onclick="showConnectDialog()">è¿æ¥å…¶ä»–è®¾å¤‡</button>
                </div>
                <div id="hostInfo" style="margin-top: 10px; font-size: 14px; color: #666; display: none;">
                    <p>æœ¬æœºIP: <span id="localIP">è·å–ä¸­...</span></p>
                    <p>è®¾å¤‡ID: <span id="deviceId"></span></p>
                </div>
            </div>

            <div class="substation-list" id="substationList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="add-substation">
                <input type="text" id="newSubstationName" placeholder="è¾“å…¥æ–°å˜ç”µç«™åç§°">
                <button class="btn btn-primary" onclick="addSubstation()">æ·»åŠ å˜ç”µç«™</button>
            </div>
        </div>
    </div>

    <div id="mapPage" class="page">
        <div class="map-page">
            <button class="btn back-btn" onclick="showPage('substationSelectPage')">â† è¿”å›</button>
            <div class="map-header">
                <h2 id="currentSubstationName">å˜ç”µç«™åç§°</h2>
                <div class="config-form">
                    <input type="number" id="gridCols" placeholder="æ¨ªå‘æœºå­æ•°" value="5" min="1" max="20">
                    <input type="number" id="gridRows" placeholder="çºµå‘æœºå­æ•°" value="5" min="1" max="20">
                    <button class="btn btn-primary" onclick="generateGrid()" style="width: auto; padding: 8px 15px;">ç”Ÿæˆåœ°å›¾</button>
                </div>
            </div>
            <div class="map-container">
                <div class="machine-grid" id="machineGrid"></div>
            </div>
        </div>
    </div>

    <div id="machineDetailPage" class="page">
        <div class="machine-detail-page">
            <button class="btn back-btn" onclick="showPage('mapPage')">â† è¿”å›</button>

            <div class="detail-card">
                <h3>æ‹ç…§åŠŸèƒ½</h3>
                <div class="camera-container" id="cameraContainer" style="display: none;">
                    <video id="videoElement" autoplay></video>
                </div>
                <div class="camera-controls" id="cameraControls" style="display: none;">
                    <button class="btn btn-primary" onclick="capturePhoto()">æ‹ç…§</button>
                    <button class="btn btn-danger" onclick="stopCamera()">å–æ¶ˆ</button>
                </div>
                <button class="btn btn-primary" onclick="startCamera()">æ‰“å¼€æ‘„åƒå¤´</button>
                <img id="capturedImage" class="camera-preview" alt="æ‹æ‘„çš„ç…§ç‰‡">
            </div>

            <div class="detail-card">
                <h3>æœºå­ä¿¡æ¯</h3>
                <div class="form-group">
                    <label>æœºå­åç§°</label>
                    <input type="text" id="machineName" placeholder="è¾“å…¥æœºå­åç§°">
                </div>
                <div class="form-group">
                    <label>æœºå­ä¿¡æ¯</label>
                    <textarea id="machineInfo" placeholder="è¾“å…¥æœºå­è¯¦ç»†ä¿¡æ¯"></textarea>
                </div>
                <img id="savedImagePreview" class="image-preview" alt="ä¿å­˜çš„å›¾ç‰‡">
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveMachineInfo()">ä¿å­˜ä¿¡æ¯</button>
                    <button class="btn btn-danger" onclick="clearMachineInfo()">æ¸…é™¤ä¿¡æ¯</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/db.js"></script>
    <script src="/static/sync.js"></script>
    <script>
        let currentSubstationId = null;
        let currentMachineX = null;
        let currentMachineY = null;
        let currentMachine = null;
        let stream = null;

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'mapPage') {
                loadMachines();
            } else if (pageId === 'substationSelectPage') {
                stopCamera();
                loadSubstations();
            }
        }

        async function loadSubstations() {
            try {
                const substations = await getAllSubstations();
                const listEl = document.getElementById('substationList');

                if (substations.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— å˜ç”µç«™ï¼Œè¯·æ·»åŠ </div>';
                    return;
                }

                listEl.innerHTML = substations.map(s => `
                    <div class="substation-item" onclick="selectSubstation(${s.id}, '${s.name}')">
                        <span>${s.name}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteSubstation(${s.id})">åˆ é™¤</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å˜ç”µç«™å¤±è´¥:', error);
                document.getElementById('substationList').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #f44336;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        async function addSubstation() {
            const name = document.getElementById('newSubstationName').value.trim();
            if (!name) {
                showToast('è¯·è¾“å…¥å˜ç”µç«™åç§°');
                return;
            }

            try {
                await addSubstation(name);
                document.getElementById('newSubstationName').value = '';
                await loadSubstations();
                showToast('æ·»åŠ æˆåŠŸï¼');
            } catch (error) {
                showToast(error.message || 'æ·»åŠ å¤±è´¥');
            }
        }

        async function deleteSubstation(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå˜ç”µç«™åŠå…¶æ‰€æœ‰æœºå­ä¿¡æ¯å—ï¼Ÿ')) {
                return;
            }

            try {
                await deleteSubstation(id);
                await loadSubstations();
                showToast('åˆ é™¤æˆåŠŸ');
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥');
            }
        }

        function selectSubstation(id, name) {
            currentSubstationId = id;
            document.getElementById('currentSubstationName').textContent = name;
            showPage('mapPage');
            generateGrid();
        }

        function generateGrid() {
            const cols = parseInt(document.getElementById('gridCols').value) || 5;
            const rows = parseInt(document.getElementById('gridRows').value) || 5;
            const gridEl = document.getElementById('machineGrid');

            gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gridEl.innerHTML = '';

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'machine-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.innerHTML = '<div class="machine-icon">âš™ï¸</div>';
                    cell.onclick = () => openMachineDetail(x, y);
                    gridEl.appendChild(cell);
            }

            loadMachines();
        }

        async function loadMachines() {
            if (!currentSubstationId) return;

            try {
                const machines = await getMachinesBySubstationId(currentSubstationId);

                document.querySelectorAll('.machine-cell').forEach(cell => {
                    const x = parseInt(cell.dataset.x);
                    const y = parseInt(cell.dataset.y);
                    const machine = machines.find(m => m.positionX === x && m.positionY === y);

                    if (machine && (machine.name || machine.info)) {
                        cell.classList.add('has-data');
                    } else {
                        cell.classList.remove('has-data');
                    }
                });
            } catch (error) {
                console.error('åŠ è½½æœºå­ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        function openMachineDetail(x, y) {
            currentMachineX = x;
            currentMachineY = y;
            showPage('machineDetailPage');
            loadMachineInfo();
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                document.getElementById('videoElement').srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('cameraControls').style.display = 'flex';
                document.getElementById('capturedImage').classList.remove('active');
            } catch (error) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', error);
                showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('cameraControls').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg');
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('capturedImage').classList.add('active');
            document.getElementById('capturedImage').dataset.imageData = imageData;

            stopCamera();
        }

        async function loadMachineInfo() {
            if (currentSubstationId === null || currentMachineX === null || currentMachineY === null) return;

            try {
                const machine = await getMachineByPosition(currentSubstationId, currentMachineX, currentMachineY);

                if (machine) {
                    currentMachine = machine;
                    document.getElementById('machineName').value = machine.name || '';
                    document.getElementById('machineInfo').value = machine.info || '';

                    if (machine.imageData) {
                        const img = document.getElementById('savedImagePreview');
                        img.src = machine.imageData;
                        img.classList.add('active');
                    } else {
                        document.getElementById('savedImagePreview').classList.remove('active');
                    }
                } else {
                    currentMachine = null;
                    document.getElementById('machineName').value = '';
                    document.getElementById('machineInfo').value = '';
                    document.getElementById('savedImagePreview').classList.remove('active');
                }
            } catch (error) {
                console.error('åŠ è½½æœºå­ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        async function saveMachineInfo() {
            if (currentSubstationId === null || currentMachineX === null || currentMachineY === null) {
                showToast('å‚æ•°é”™è¯¯');
                return;
            }

            const name = document.getElementById('machineName').value.trim();
            const info = document.getElementById('machineInfo').value.trim();
            const imageData = document.getElementById('capturedImage').dataset.imageData || null;

            try {
                await saveMachine(currentSubstationId, currentMachineX, currentMachineY, name, info, imageData);
                showToast('ä¿å­˜æˆåŠŸï¼');

                document.getElementById('capturedImage').classList.remove('active');
                document.getElementById('capturedImage').dataset.imageData = '';

                await loadMachineInfo();
                await loadMachines();
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        async function clearMachineInfo() {
            if (!currentMachine) {
                showToast('æš‚æ— ä¿¡æ¯å¯æ¸…é™¤');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¸…é™¤è¿™æ¡æœºå­ä¿¡æ¯å—ï¼Ÿ')) {
                return;
            }

            try {
                await deleteMachine(currentMachine.id);
                showToast('æ¸…é™¤æˆåŠŸ');
                await loadMachineInfo();
                await loadMachines();
            } catch (error) {
                showToast('æ¸…é™¤å¤±è´¥');
            }
        }

        // åŒæ­¥ç›¸å…³åŠŸèƒ½
        async function startHost() {
            try {
                const result = await startBroadcast();
                document.getElementById('syncIndicator').classList.add('active');
                document.getElementById('syncStatusText').textContent = `å¹¿æ’­ä¸­: ${result.ip}:${result.port}`;
                document.getElementById('hostInfo').style.display = 'block';
                document.getElementById('localIP').textContent = result.ip;
                document.getElementById('deviceId').textContent = result.deviceId;
                document.getElementById('hostBtn').textContent = 'åœæ­¢å¹¿æ’­';
                document.getElementById('hostBtn').onclick = stopHost;

                setSyncCallbacks({
                    onPeerConnected: (peerId) => {
                        showToast(`æ–°è®¾å¤‡å·²è¿æ¥: ${peerId}`);
                    },
                    onPeerDisconnected: (peerId) => {
                        showToast(`è®¾å¤‡å·²æ–­å¼€: ${peerId}`);
                    },
                    onSyncComplete: (success, error) => {
                        if (success) {
                            showToast('åŒæ­¥æˆåŠŸï¼');
                            loadSubstations();
                        } else {
                            showToast('åŒæ­¥å¤±è´¥: ' + error);
                        }
                    }
                });

                showToast('å¼€å§‹å¹¿æ’­ï¼Œå…¶ä»–è®¾å¤‡å¯è¿æ¥');
            } catch (error) {
                showToast('å¯åŠ¨å¹¿æ’­å¤±è´¥');
            }
        }

        function stopHost() {
            stopBroadcast();
            document.getElementById('syncIndicator').classList.remove('active');
            document.getElementById('syncStatusText').textContent = 'æœªè¿æ¥';
            document.getElementById('hostInfo').style.display = 'none';
            document.getElementById('hostBtn').textContent = 'å¼€å§‹å¹¿æ’­';
            document.getElementById('hostBtn').onclick = startHost;
            showToast('å·²åœæ­¢å¹¿æ’­');
        }

        function showConnectDialog() {
            const hostIP = prompt('è¯·è¾“å…¥ä¸»æœºIPåœ°å€:');
            if (hostIP && hostIP.trim()) {
                requestSyncFrom(hostIP.trim()).then(success => {
                    if (success) {
                        document.getElementById('syncIndicator').classList.add('active');
                        document.getElementById('syncStatusText').textContent = `å·²è¿æ¥åˆ°: ${hostIP}`;
                        showToast('è¿æ¥æˆåŠŸï¼');
                    } else {
                        showToast('è¿æ¥å¤±è´¥');
                    }
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            await loadSubstations();
            registerServiceWorker();
            checkIfInstalled();
        });

        let deferredPrompt;

        function checkIfInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }

            if ('serviceWorker' in navigator) {
                setTimeout(() => {
                    if (!deferredPrompt) {
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.classList.add('show');
                        }
                    }
                }, 2000);
            }
        }

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

        // æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºä¸åŒçš„å®‰è£…æ­¥éª¤
        if (isIOS) {
            document.getElementById('iosStep1').style.display = 'block';
            document.getElementById('androidStep1').style.display = 'none';
            document.getElementById('iosStep2').style.display = 'block';
            document.getElementById('androidStep2').style.display = 'none';
        }

        window.addEventListener('load', async () => {
            await loadSubstations();
            registerServiceWorker();

            // å¦‚æœå·²ç»å®‰è£…ï¼Œéšè—å®‰è£…æç¤º
            if (isStandalone) {
                return;
            }

            // ç«‹å³æ˜¾ç¤ºå®‰è£…æç¤º
            showInstallButton();
        });

        function dismissInstall() {
            document.getElementById('installBanner').classList.remove('show');
            // ä¿å­˜é€‰æ‹©ï¼Œä¸€å‘¨å†…ä¸å†æ˜¾ç¤º
            localStorage.setItem('installDismissed', Date.now());
        }

        window.addEventListener('beforeunload', () => {
            stopCamera();
        });

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/static/service-worker.js');
                    console.log('Service Workeræ³¨å†ŒæˆåŠŸ:', registration.scope);
                } catch (error) {
                    console.log('Service Workeræ³¨å†Œå¤±è´¥:', error);
                }
            }
        }

        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            if (isStandalone) {
                return;
            }

            const installBtn = document.getElementById('installBtn');
            const banner = document.getElementById('installBanner');
            if (installBtn) {
                installBtn.classList.add('show');
            }
            if (banner) {
                banner.classList.add('show');
            }
        }

        function showManualInstall() {
            // è®¾ç½®è®¾å¤‡ç±»å‹
            if (isIOS) {
                document.getElementById('modalIosStep1').style.display = 'block';
                document.getElementById('androidStep1').style.display = 'none';
                document.getElementById('modalIosStep2').style.display = 'block';
                document.getElementById('androidStep2').style.display = 'none';
            }
            
            document.getElementById('installBanner').classList.remove('show');
            document.getElementById('manualInstallModal').classList.add('show');
        }

        function closeManualInstall() {
            document.getElementById('manualInstallModal').classList.remove('show');
        }

        async function installApp() {
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('ç”¨æˆ·é€‰æ‹©:', outcome);
                    if (outcome === 'accepted') {
                        showToast('å®‰è£…æˆåŠŸï¼åº”ç”¨å·²æ·»åŠ åˆ°ä¸»å±å¹•');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn')?.classList.remove('show');
                    document.getElementById('installBanner')?.classList.remove('show');
                } catch (error) {
                    console.error('å®‰è£…å¤±è´¥:', error);
                    showManualInstall();
                }
            } else {
                showManualInstall();
            }
        }

        function showManualInstallInstructions() {
            if (isIOS) {
                showToast('iPhone: ç‚¹å‡»åº•éƒ¨åˆ†äº«æŒ‰é’® â†’ æ·»åŠ åˆ°ä¸»å±å¹•');
            } else {
                showToast('Android: ç‚¹å‡»å³ä¸Šè§’èœå• â†’ æ·»åŠ åˆ°ä¸»å±å¹•');
            }
        }
    </script>
</body>
</html>
